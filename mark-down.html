<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="marked-import.html">

<!--
Web Component wrapper for Markdown using Polymer.

Example:

    <mark-down text="Hello, **world!**"></mark-down>

    or alternatively:

    <mark-down>
      Hello, **world!**
    </mark-down>

Please be aware that you cannot safely change the text content of a `mark-down`
element after it has been created. This is due to Polymer 0.8's shady DOM.
The generated markdown elements may also be in the owning document rather than
a shadow root.
-->
<dom-module id="mark-down">

  <link rel="stylesheet" href="mark-down.css">

  <template>
    <div id="markdown"></div>
  </template>

</dom-module>

<script>

  Polymer({

    is: 'mark-down',

    /**
     * The `mark-down-ready` event is fired after the marked-up HTML is
     * inserted into the parent container.
     *
     * @event mark-down-ready
     */

    published: {
      /** A string of markdown that you wish to see rendered. */
      text: String,
    },

    bind: {
      'text': 'textChanged',
    },

    configure: function(properties) {
      return {
        text: properties.text || this._unindent(this.textContent),
      };
    },

    textChanged: function() {
      this.$.markdown.innerHTML = this.text ? marked(this.text) : '';
      this.fire('mark-down-ready');
    },

    // Find the shortest indented line (ignoring blank lines), and remove all
    // indentation up to that point.
    _unindent: function(str) {
      // two spaces for tabs as a guess - we don't want to get into the business
      // of trying to detect tab sizes.
      var lines  = str.replace(/\t/g, '  ').split('\n');
      var indent = lines.reduce(function(prev, line) {
        if (/^\s*$/.test(line)) return prev;  // Completely ignore blank lines.

        var lineIndent = line.match(/^(\s*)/)[0].length;
        if (prev === null) return lineIndent;
        return lineIndent < prev ? lineIndent : prev;
      }, null);

      return lines.map(function(l) { return l.substr(indent); }).join('\n');
      return str.replace(/^[^\S\n]+/gm, '');
    },

  });

</script>
